<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Data Visualization Project Plot</title>
    <style>
        body {
            margin: 0;
            overflow-x: hidden;
            font-family: Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Styling for the grid lines */
        .x-axis line,
        .y-axis line {
            stroke: #ccc;
            stroke-dasharray: 2, 2;
        }

        .x-axis .domain,
        .y-axis .domain {
            stroke: none;
        }

        /* Container styles */
        .chart-container {
            position: relative;
            margin: 0;
            width: 100%;
            height: 100%;
        }

        /* New dashboard structure using flexbox for top/bottom split */
        .dashboard {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        /* Top half container (Vis1) */
        .dash-top {
            flex: 2;
            min-height: 0;
            padding: 10px;
            box-sizing: border-box;
        }

        /* Bottom half container (Sankey and Circle) */
        .dash-bottom {
            flex: 1;
            display: flex;
            min-height: 0;
            padding: 10px;
            box-sizing: border-box;
        }

        /* Item within the bottom half (Sankey/Circle) */
        .chart-item {
            flex: 1;
            margin: 0 20px;
            height: 100%;
        }

        /* Sankey Diagram (75% of bottom width) */
        #chart-sankey {
            flex: 15 1 0%;
            margin-left: 0;
            margin-right: 20px;
        }

        /* Circle Diagram (15% of bottom width) */
        #chart-circle {
            flex: 3 1 0%;
            margin-left: 0;
            margin-right: 20px;
        }

        /* Global Legend (10% of bottom width) */
        #global-legend {
            flex: 2 1 0%;
            height: 100%;
            padding: 10px;
            box-sizing: border-box;
            margin-left: 0;
            margin-right: 0;
        }

        /* Legend Specific Styles for better alignment (These make the colors visible) */
        .legend-item {
            display: flex;
            /* Aligns swatch and text horizontally */
            align-items: center;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .color-swatch {
            width: 15px;
            /* Size of the color square */
            height: 15px;
            margin-right: 8px;
            /* Spacing between color and text */
            border-radius: 3px;
        }
    </style>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>

<body>
    <div id="loading-overlay" style="position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255, 255, 255, 0.95); 
            z-index: 2000; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            font-family: Arial, sans-serif;">

        <h2>Choose Visualization Start Mode</h2>

        <div style="margin: 20px 0;">
            <button onclick="startVisualization(true)"
                style="padding: 15px 30px; margin: 10px; font-size: 16px; background-color: #4CAF50; color: white; border: none; cursor: pointer;">
                Fast, Pre-calculated Start (Recommended)
            </button>
            <button onclick="startVisualization(false)"
                style="padding: 15px 30px; margin: 10px; font-size: 16px; background-color: #008CBA; color: white; border: none; cursor: pointer;">
                Slow, Pure Force Directed Start
            </button>
        </div>
        <p style="color: #666;">Choosing the Slow Start will re-run the D3 simulation, which may take several seconds.
        </p>
    </div>
    <button onclick="snapshotCurrentPositions()"
        style="position: fixed; top: 10px; right: 10px; z-index: 1000; padding: 5px 10px;">
        Snapshot Positions
    </button>
    <div class="dashboard">
        <div class="dash-top">
            <div id="chart-vis1" class="chart-container"></div>
        </div>
        <div class="dash-bottom">
            <div id="chart-sankey" class="chart-item">
                <div id="sankey-error"></div>
            </div>
            <div id="chart-circle" class="chart-item"></div>
            <div id="global-legend"></div>
        </div>
    </div>

    <script src="Vis1.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <script src="sankey.js"></script>
    <script src="circle.js"></script>

    <script>
        window.usePrecalculatedPositions = true;
        // --- Utility Functions (Must be global for all charts) ---
        function mapEdu(code) {
            switch (+code) {
                case 1: return 'High School <';
                case 2: return 'Associates <';
                case 3: return 'Bachelor';
                case 4: return 'Masters +';
                default: return 'Unknown';
            }
        }
        function mapInc(code) {
            switch (+code) {
                case 1:
                case 2:
                case 3: return '<$50k';
                case 4:
                case 5: return '$50k - $100k';
                case 6:
                case 7: return '$100k - $150k';
                case 8: return '$>150k'; // Corrected Label to match global list
                default: return null;
            }
        }

        // --- Global State to track active filters (initially all) ---
        const allParties = ["Democrat", "Republican", "Independent", "Other"];
        window.activeParties = new Set(allParties);
        const allIncomes = ['<$50k', '$50k - $100k', '$100k - $150k', '$>150k'];
        window.activeIncomes = new Set(allIncomes);

        const allEdus = ['High School <', 'Associates <', 'Bachelor', 'Masters +', 'Unknown'];
        window.activeEdus = new Set(allEdus);

        window.highlightedID = null;

        // --- Universal Update Function for all Charts ---
        function updateAllCharts() {
            // Re-render each chart, applying the current global filters
            try {
                if (window.rlsData) {
                    // This function is in Vis1.js and recalculates points based on all global filters
                    updateChart(window.rlsData);
                }
            } catch (e) { console.error('Failed to update Vis1', e); }

            // Re-run Sankey and Circle render functions, which check global filters internally
            try { renderSankey('#chart-sankey'); } catch (e) { console.error('Failed to render sankey', e); }
            try { renderCircle('#chart-circle'); } catch (e) { console.error('Failed to render circle', e); }
        }

        // --- Legend Renderer with Interactivity (Party filter only) ---
        function renderGlobalLegend(containerSelector = '#global-legend') {
            const container = d3.select(containerSelector);
            if (container.empty()) return;

            const partyDomains = ["Democrat", "Republican", "Independent", "Other"];
            const partyColors = ["#76b7b2ff", "#e15759", "#f28e2c", "#59a14f"];

            container.html(''); // Clear previous content

            container.append('div')
                .style('font-weight', 'bold')
                .style('margin-bottom', '10px')
                .text('Party Affiliation');

            const legendItems = container.selectAll(".legend-item")
                .data(partyDomains)
                .enter()
                .append("div")
                .attr("class", "legend-item")
                // --- Add the Click Handler to each legend item ---
                .on("click", function (event, d) {
                    if (window.activeParties.has(d)) {
                        window.activeParties.delete(d);
                    } else {
                        window.activeParties.add(d);
                    }

                    // Re-add all if all are deselected (optional: keep at least one selected)
                    if (window.activeParties.size === 0) {
                        window.activeParties = new Set(allParties);
                    }

                    // Update the visual state of the legend
                    d3.select(this)
                        .style("opacity", window.activeParties.has(d) ? 1 : 0.5);

                    // Un-highlight any specific respondent
                    window.highlightedID = null;

                    updateAllCharts();
                })
                .style("cursor", "pointer"); // Indicate it's clickable

            // Add the color swatch
            legendItems.append("div")
                .attr("class", "color-swatch")
                .style("background-color", (d, i) => partyColors[i]);

            // Add the text label
            legendItems.append("span")
                .text(d => d);

            // Initial styling based on the active state
            legendItems.style("opacity", d => window.activeParties.has(d) ? 1 : 0.5);
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            renderGlobalLegend('#global-legend');
            // Vis1.js loads data and calls updateAllCharts() when ready.
        });

    </script>
</body>

</html>